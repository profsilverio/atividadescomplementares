<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Atividades Complementares</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap e Ícones -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- CSS personalizado -->
  <link rel="stylesheet" href="style.css">

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h2 class="mb-4">
      Registro de Atividades Complementares
      <span class="float-end">
        <button class="btn btn-sm btn-outline-primary me-2" onclick="exportarJSON()">
          <i class="bi bi-download"></i> Backup - Exportar JSON
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('importJSON').click()">
          <i class="bi bi-upload"></i> Backup - Importar JSON
        </button>
        <input type="file" id="importJSON" accept=".json" style="display:none" onchange="importarJSON(this)">
      </span>
    </h2>

    <!-- Formulário -->
    <div class="card mb-4">
      <div class="card-body">
        <form id="atividadeForm" class="row g-3">

          <!-- Dados do aluno -->
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Nome do Aluno</label>
              <input type="text" id="nomeAluno" class="form-control" required>
            </div>

            <div class="col-12 col-md-2">
              <label class="form-label">CPF</label>
              <input type="text" id="cpfAluno" class="form-control" required>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Curso</label>
              <select id="cursoAluno" class="form-select" required>
                <option value="">Selecione...</option>
                <option value="Tecnologia em Análise e Desenvolvimento de Sistemas">Tecnologia em Análise e Desenvolvimento de Sistemas</option>
                <option value="Bacharelado em Agronomia">Bacharelado em Agronomia</option>
                <option value="Curso Técnico em Agropecuária">Curso Técnico em Agropecuária</option>
                <option value="Curso Técnico em Informática">Curso Técnico em Informática</option>
              </select>
            </div>

            <div class="col-12 col-md-2">
              <label class="form-label">Semestre de Formatura</label>
              <input type="text" id="semestreAluno" class="form-control" placeholder="Ex.: 1/2025" required>
            </div>
          </div>

          <div class="col-md-2">
            <label class="form-label">Data do Evento</label>
            <input type="date" id="data" class="form-control" required>
          </div>
<div class="col-md-2">
  <label class="form-label">Semestre da Atividade</label>
  <input type="text" id="semestreAtividade" class="form-control" 
         placeholder="Ex.: 1/2025" required readonly>
  <div class="form-hint">Formato: 1/AAAA ou 2/AAAA</div>
</div>

          <div class="col-md-4">
            <label class="form-label">Nome do Evento</label>
            <input type="text" id="evento" class="form-control" required>
          </div>

          <div class="col-md-2">
            <label class="form-label">Categoria</label>
            <select id="categoria" class="form-select" required></select>
            <div class="form-hint" id="countCategoria">0 atividades nesta categoria</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Tipo</label>
            <select id="tipo" class="form-select" required></select>
            <div class="form-hint" id="countTipo">0 atividades deste tipo</div>
          </div>
          <div class="col-md-3 d-none" id="grupoAreaEspecifica">
            <label class="form-label">Pontuação diferenciada</label>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="areaEspecifica">
              <label class="form-check-label" for="areaEspecifica">
                Da área específica do curso
              </label>
            </div>
            <div class="form-hint">Marque quando a regra prevê pontuação maior para área específica.</div>
          </div>
          <div class="col-md-2">
            <label class="form-label d-flex justify-content-between">
              <span>Quantidade</span>
              <span id="unidadeBadge" class="badge text-bg-secondary badge-unidade">horas</span>
            </label>
            <input type="number" step="0.1" id="quantidade" class="form-control" min="0.1" required>
            <div id="quantidadeHint" class="form-hint">Informe a carga referente à regra (horas / eventos / meses).</div>
          </div>

          <div class="col-12">
            <button type="submit" class="btn btn-success">Adicionar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bloco com dados do aluno -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Dados do Aluno</h5>
        <table class="table table-bordered">
          <tbody>
            <tr>
              <th>Nome</th>
              <td id="alunoNomeTabela"></td>
              <th>CPF</th>
              <td id="alunoCpfTabela"></td>
            </tr>

            <tr>
              <th>Semestre de Formatura</th>
              <td id="alunoSemestreTabela"></td>
              <th>Curso</th>
              <td id="alunoCursoTabela"></td>
            </tr>
          </tbody>
        </table>
                    <div class="mt-3">
  <button id="btnExcluirAluno" class="btn btn-danger" onclick="excluirAluno()">
    <i class="bi bi-trash"></i> Excluir Dados do Aluno
  </button>
</div>
      </div>
    </div>

    <!-- Tabela de atividades -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Atividades Lançadas</h5>
        <div class="table-responsive">
          <table class="table table-bordered align-middle" id="tabelaAtividades">
            <thead class="table-dark">
              <tr>
                <th>Data</th>
                <th>Semestre</th>
                <th>Evento</th>
                <th>Categoria</th>
                <th>Tipo</th>
                <th>Quantidade</th>
                <th>Pontos (brutos)</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="form-hint">
          Observação: os pontos exibidos por linha são os <b>brutos</b>. Os <b>totais</b> abaixo e o PDF respeitam os limites por subcategoria no semestre e por categoria (semestral e total do curso), gerando apenas pontos <b>válidos</b>.
        </div>
      </div>
    </div>

    <!-- Totais -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Totais (limitados conforme regulamento)</h5>
        <ul id="totaisCategoria" class="list-group mb-3"></ul>
        <h4>Total Geral: <span id="totalGeral">0</span> pontos</h4>
      </div>
    </div>

    <!-- Botões fixos -->
    <div class="sticky-actions">
      <button class="btn btn-primary" onclick="gerarPDF()">Gerar PDF</button>
      <button class="btn btn-danger" onclick="limparDados()">Limpar Todos os Dados</button>
      <button class="btn btn-info" onclick="abrirInstrucoes()">Orientações</button>
    </div>
  </div>

  <script>

/* ============================
   AUTO-PREENCHER SEMESTRE DA ATIVIDADE (robusto)
   ============================ */
document.addEventListener("DOMContentLoaded", function () {
  const dataInput = document.getElementById("data");
  const semInput  = document.getElementById("semestreAtividade");

  if (!dataInput || !semInput) {
    console.error("Auto-preencher: elemento(s) não encontrados:", {
      data: !!dataInput,
      semestre: !!semInput
    });
    return;
  }

  function preencherSemestre(dataValor) {
    if (!dataValor) {
      semInput.value = "";
      return;
    }

    try {
      // Forçar horário para evitar problema de fuso horário
      const iso = dataValor.includes("T") ? dataValor : dataValor + "T00:00:00";
      const dt = new Date(iso);

      if (isNaN(dt.getTime())) {
        console.warn("Auto-preencher: data inválida ->", dataValor);
        semInput.value = "";
        return;
      }

      const ano = dt.getFullYear();
      const mes = dt.getMonth() + 1;
      const semestre = mes <= 6 ? 1 : 2;
      semInput.value = `${semestre}/${ano}`;
    } catch (err) {
      console.error("Auto-preencher: erro ao processar data", err);
      semInput.value = "";
    }
  }

  // Captura quando o usuário seleciona a data (change) ou digita/cola (input)
  dataInput.addEventListener("change", function () { preencherSemestre(this.value); });
  dataInput.addEventListener("input",  function () { preencherSemestre(this.value); });

  // Se já existir valor ao carregar a página (situação de edição/carregamento de localStorage)
  if (dataInput.value) {
    preencherSemestre(dataInput.value);
  }

  // Limpa o semestre caso o campo data seja apagado
  dataInput.addEventListener("blur", function () {
    if (!this.value) semInput.value = "";
  });
});

  </script>
    <script src="script.js"></script>
</body>
</html>
